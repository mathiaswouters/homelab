---

- name: Check if runner token is defined
  ansible.builtin.fail:
    msg: |
      GitLab runner token is not defined!
      
      Please set it up:
        mkdir -p group_vars/gitlab-runner
        ansible-vault create group_vars/gitlab-runner/vault.yml
         
        Add: vault_gitlab_runner_token: "glrt-your-token"
         
        Then create group_vars/gitlab-runner/vars.yml with:
        gitlab_runner_token: "{{ vault_gitlab_runner_token }}"
  when: gitlab_runner_token is not defined or gitlab_runner_token == ""

- name: Validate token format
  ansible.builtin.fail:
    msg: "Invalid token format. Token should start with 'glrt-' ..."
  when: not gitlab_runner_token.startswith('glrt-')

- name: Ensure GitLab Runner config directory exists
  ansible.builtin.file:
    path: /etc/gitlab-runner
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy GitLab Runner config.toml from template
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/gitlab-runner/config.toml
    owner: root
    group: root
    mode: '0600'
    backup: true
  become: true
  notify: restart gitlab-runner

- name: Ensure GitLab Runner service is running
  ansible.builtin.systemd:
    name: gitlab-runner
    state: started
    enabled: true
  become: true

- name: Verify runner configuration
  ansible.builtin.command: gitlab-runner verify
  register: runner_verify
  changed_when: false
  failed_when: false
  become: true

- name: Display verification result
  ansible.builtin.debug:
    var: runner_verify.stdout_lines

- name: Check runner status
  ansible.builtin.command: gitlab-runner list
  register: runner_list
  changed_when: false
  become: true

- name: Display registered runners
  ansible.builtin.debug:
    msg: "{{ runner_list.stdout_lines }}"
