---
# GitLab installation tasks

- name: Create GitLab directory structure
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ gitlab_home }}"
    - "{{ gitlab_home }}/config"
    - "{{ gitlab_home }}/logs"
    - "{{ gitlab_home }}/data"

- name: Deploy docker-compose.yml for GitLab
  template:
    src: docker-compose.yml.j2
    dest: "{{ gitlab_home }}/docker-compose.yml"
    mode: '0644'
  register: compose_file

- name: Start GitLab container with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ gitlab_home }}"
    state: present
  register: docker_output

- name: Wait for GitLab container to be running
  docker_container_info:
    name: gitlab
  register: gitlab_container
  until: gitlab_container.exists and gitlab_container.container.State.Running
  retries: 10
  delay: 5

- name: Wait for GitLab to be healthy (this may take 5-10 minutes)
  shell: docker exec gitlab gitlab-ctl status
  register: gitlab_status
  until: gitlab_status.rc == 0
  retries: 60
  delay: 10
  changed_when: false
  failed_when: false

- name: Display GitLab startup message
  debug:
    msg: "GitLab is initializing. This process can take several minutes..."

- name: Wait additional time for GitLab initialization
  wait_for:
    timeout: 30
  delegate_to: localhost

- name: Get GitLab IP address
  shell: docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' gitlab
  register: gitlab_ip
  changed_when: false

- name: Get initial root password
  shell: docker exec gitlab grep 'Password:' /etc/gitlab/initial_root_password 2>/dev/null || echo "Password file not yet created"
  register: root_password
  changed_when: false
  failed_when: false

- name: Display GitLab access information
  debug:
    msg:
      - "=== GitLab Installation Complete ==="
      - "Access URL: {{ gitlab_ip }}"
      - "Username: root"
      - "{{ root_password.stdout }}"
      - ""
      - "IMPORTANT: The password file will be automatically deleted after 24 hours"
      - "Change the root password immediately after first login!"
      - ""
      - "Useful commands:"
      - "  - Monitor logs: sudo docker logs -f gitlab"
      - "  - Check status: sudo docker exec -it gitlab gitlab-ctl status"
      - "  - Restart GitLab: sudo docker restart gitlab"
  when: root_password.stdout is defined
